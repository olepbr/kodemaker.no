:title MQTT - Hva er det?
:author fredrik
:tech [:mqtt :IoT]
:published 2020-05-06

:blurb

MQTT er et lettvekts publish-subscribe meldingssystem. Men hva i alle dager står forkortelsen for? Hva kan man bruke det til? Og hvordan fungerer det, egentlig? 

:body

MQTT står for Message Queueing Telemetry Transport. Det er et lettvekts publish-subcribe meldingssystem. Det ble opprinnelig laget av to duder i 1999, for å overføre telemetri-data fra oljeledninger over satelitt. Det har senere blitt en ISO-standard. 

Det er veldig enkelt og lettvekts, designet for lav båndbredde og ustabile nettverk, og det er laget for at klientene skal kunne kjøre på svak hardware og bruke lite strøm. 

## Hva kan det brukes til
Selv bruker jeg MQTT hjemme for å sende meldinger fra arduino-dingser til hjemmeautomasjonssystemet Openhab, så Openhab får vite hva stuetemperaturen er eller om noen ringer på døra. Et annet eksempel på virksomhetskritisk bruk av MQTT; i Storbritannia brukes MQTT i et signalsystem for togfremføring. Men de kanskje mest kjente produktene som bruker MQTT, i alle fall inntil nylig,
er Facebook-appen og Facebook Messenger. De bruker det for å levere meldinger til telefonen din. Også den mest omtalte appen i Norge
den siste tiden; Smittestopp, bruker MQTT for å sende informasjon til skyen. Så MQTT er altså godt egnet til å skjende personvern. 

Men det er innen IoT at MQTT har oppnådd størst popularitet. 

## Hvordan fungerer det
La oss ta en titt på hvordan MQTT fungerer. Man trenger en MQTT-server (også kjent som en Broker), som tar i mot og sender meldinger til klientene. En klient sender meldinger til en topic på serveren, f.eks. til topicen `hus/soverom/temperatur`. Når MQTT-serveren mottar meldingen vil den videresendes til alle klientene som lytter til denne topicen. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="93 77.5 860.632 439" width="860.632" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M380 78h286v438H380z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M380 78h286v438H380z"/><text transform="translate(385 83)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(98 145)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher</tspan></text><text transform="translate(434.68 134)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/temperatur</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.672 153.147l250.112-7.024"/><path fill="#fff" d="M246.459 136.189h41.136v28.448h-41.136z"/><text transform="translate(251.46 141.19)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(871 141.19)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M616.32 144.958l239.782 4.457"/></g><g><path fill="#fff" d="M689.24 132.472h41.136v28.448H689.24z"/><text transform="translate(694.24 137.472)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text></g><g><text transform="translate(787 173)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/soverom/temperatur</tspan></text></g></g></svg>

I dette eksempelet sender en Arduino-dings med temperaturføler soveromstemperaturen til en topic på MQTT-serveren, og så mottas denne meldingen av Openhab, som lytter på denne topicen. 

Dette er ikke bare MQTTs svar på hello-world, men et helt realistisk eksempel fra "produksjon". Når man bruker MQTT, i allefall i IoT-verdenen, er det vanlig med fin-granulerte topics og meldinger med små payloads. Dersom det finnes flere sensorer, f.eks. en luftfuktighetsmåler, på Arduino-dingsen, vil den typisk publisere luftfuktighet til en annen topic. En topic opprettes automatisk på MQTT-serveren når en melding publiseres på den, og "forsvinner" når det ikke ligger meldinger på den. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="84 73.223 582.5 439" width="582.5" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M380 73.723h286v438H380z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M380 73.723h286v438H380z"/><text transform="translate(385 78.723)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(89 168.61)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher1</tspan></text><text transform="translate(434.68 134)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/temperatur</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 174.096l250.25-21.859"/><path fill="#fff" d="M246.394 151.365h41.136v28.448h-41.136z"/><text transform="translate(251.394 156.365)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(434.68 167.29)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/luftfuktighet</tspan></text><text transform="translate(434.68 200.436)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(434.68 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/temperatur</tspan></text><text transform="translate(434.68 266.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/luftfuktighet</tspan></text><text transform="translate(434.68 299.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/online</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 177.692l250.212-.827"/><path fill="#fff" d="M302.665 162.982h27.792v28.448h-27.792z"/><text transform="translate(307.665 167.982)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 181.433l250.247 21.054"/><path fill="#fff" d="M331.129 182.394h37.856v28.448h-37.856z"/><text transform="translate(336.13 187.394)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(89 258)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher2</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 264.479L419.8 248.427"/><g><path fill="#fff" d="M246.394 244.008h41.136v28.448h-41.136z"/><text transform="translate(251.394 249.008)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 268.181l250.215 5.597"/></g><g><path fill="#fff" d="M302.665 257.245h27.792v28.448h-27.792z"/><text transform="translate(307.665 262.245)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">54</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 272.129l250.276 28.691"/></g><g><path fill="#fff" d="M331.129 278.595h37.856v28.448h-37.856z"/><text transform="translate(336.13 283.595)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text></g></g></svg>

I dette eksempelet så har vi altså to temperatur- og luftfuktighetssensor, en på soverommet, og en på stua. Begge to publiserer til tre topics hver, en for å angi temperatur og en for luftfuktighet og til slutt online som, ganske riktig, sier om enheten er online eller ikke.

## Abonnere på topics
Skråstreken(`/`) i topicene kalles for en topic level separator. Når man abonnerer på en topic, så kan man lytte på en bestemt topic som vi så i et tidligere eksempel. Eller man kan bruke _wildcards_, hvor vi kan velge blant `#` eller `+`. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="84 73.319 904.632 439" width="904.632" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M378.589 73.819h286v438h-286z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M378.589 73.819h286v438h-286z"/><text transform="translate(383.589 78.82)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(89 168.61)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher1</tspan></text><text transform="translate(440.6 127)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/temperatur</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 173.406l256.185-26.507"/><path fill="#fff" d="M248.611 148.875h41.136v28.448h-41.136z"/><text transform="translate(253.61 153.875)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(434.68 167.29)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/luftfuktighet</tspan></text><text transform="translate(434.68 200.436)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(434.68 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/temperatur</tspan></text><text transform="translate(434.68 266.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/luftfuktighet</tspan></text><text transform="translate(434.68 299.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/online</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 177.692l250.212-.827"/><path fill="#fff" d="M302.665 162.982h27.792v28.448h-27.792z"/><text transform="translate(307.665 167.982)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 181.433l250.247 21.054"/><path fill="#fff" d="M331.129 182.394h37.856v28.448h-37.856z"/><text transform="translate(336.13 187.394)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(89 258)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher2</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 264.479L419.8 248.427"/><path fill="#fff" d="M246.394 244.008h41.136v28.448h-41.136z"/><text transform="translate(251.394 249.008)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 268.181l250.215 5.597"/><path fill="#fff" d="M302.665 257.245h27.792v28.448h-27.792z"/><text transform="translate(307.665 262.245)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">54</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 272.129l250.276 28.691"/><path fill="#fff" d="M331.129 278.595h37.856v28.448h-37.856z"/><text transform="translate(336.13 283.595)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><g><text transform="translate(906 156.365)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M622.24 142.813l268.885 18.985"/></g><g><path fill="#fff" d="M706.048 135.959h41.136v28.448h-41.136z"/><text transform="translate(711.048 140.959)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text></g><g><text transform="translate(878.918 189.45)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/soverom/#</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M622.24 174.003l268.863-7.013"/></g><g><path fill="#fff" d="M712.72 157.056h27.792v28.448H712.72z"/><text transform="translate(717.72 162.056)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M580.448 202.105l310.701-31.138"/></g><g><path fill="#fff" d="M671.788 176.666h41.136v28.448h-41.136z"/><text transform="translate(676.788 181.666)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="1.64" y="15">true</tspan></text></g></g></svg>

`#` kalles multilevel wildcard, og betyr alle subtopics. Dette må _alltid_ være til slutt når du tegner abonnement. Du kan f.eks. abonnere på `hus/soverom/#`, og få alle meldinger som publiseres på subtopics til `hus/soverom`. I vårt eksempel er det altså `hus/soverom/luftfuktighet`, `hus/soverom/temperatur` og `hus/soverom/online`. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="84 73.319 925.941 439" width="925.941" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M378.589 73.819h286v438h-286z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M378.589 73.819h286v438h-286z"/><text transform="translate(383.589 78.82)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(89 168.61)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher1</tspan></text><text transform="translate(440.6 127)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/temperatur</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 173.406l256.185-26.507"/><path fill="#fff" d="M248.611 148.875h41.136v28.448h-41.136z"/><text transform="translate(253.61 153.875)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(434.68 167.29)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/luftfuktighet</tspan></text><text transform="translate(434.68 200.436)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(434.68 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/temperatur</tspan></text><text transform="translate(434.68 266.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/luftfuktighet</tspan></text><text transform="translate(434.68 299.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/online</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 177.692l250.212-.827"/><path fill="#fff" d="M302.665 162.982h27.792v28.448h-27.792z"/><text transform="translate(307.665 167.982)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 181.433l250.247 21.054"/><path fill="#fff" d="M331.129 182.394h37.856v28.448h-37.856z"/><text transform="translate(336.13 187.394)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(89 258)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher2</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 264.479L419.8 248.427"/><path fill="#fff" d="M246.394 244.008h41.136v28.448h-41.136z"/><text transform="translate(251.394 249.008)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 268.181l250.215 5.597"/><path fill="#fff" d="M302.665 257.245h27.792v28.448h-27.792z"/><text transform="translate(307.665 262.245)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">54</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 272.129l250.276 28.691"/><path fill="#fff" d="M331.129 278.595h37.856v28.448h-37.856z"/><text transform="translate(336.13 283.595)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(927.309 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M587.268 150.448l325.423 79.331"/><path fill="#fff" d="M692.15 166.806h41.136v28.448H692.15z"/><text transform="translate(697.15 171.806)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(910 266.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/#</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M620.406 190.739l292.113 43.993"/><g><path fill="#fff" d="M719.552 193.539h27.792v28.448h-27.792z"/><text transform="translate(724.552 198.54)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M580.448 215.079l331.986 23.866"/></g><g><path fill="#fff" d="M679.227 209.435h41.136v28.448h-41.136z"/><text transform="translate(684.227 214.435)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="1.64" y="15">true</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M585.2 242.805h327.209"/></g><g><path fill="#fff" d="M707.423 228.581h41.136v28.448h-41.136z"/><text transform="translate(712.423 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M591.12 269.96l321.315-23.267"/></g><g><path fill="#fff" d="M678.238 248.421h27.792v28.448h-27.792z"/><text transform="translate(683.238 253.421)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">54</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M549.328 300.521l363.175-50.291"/></g><g><path fill="#fff" d="M658.971 268.266h41.136v28.448h-41.136z"/><text transform="translate(663.971 273.266)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="1.64" y="15">true</tspan></text></g></g></svg>

Ved å abonnere på `hus/#` får man alle meldinger som publiseres på subtopics av `hus`. Man kan også abonnere på bare `#`, og få alle meldingene som publiseres på MQTT-severen. Men det er ikke sikkert det alltid er en god idé.

<svg xmlns="http://www.w3.org/2000/svg" viewBox="84 73.319 908.628 439" width="908.628" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M378.589 73.819h286v438h-286z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M378.589 73.819h286v438h-286z"/><text transform="translate(383.589 78.82)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(89 168.61)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher1</tspan></text><text transform="translate(434.68 130)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/temperatur</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 173.664l250.259-24.386"/><path fill="#fff" d="M246.394 149.949h41.136v28.448h-41.136z"/><text transform="translate(251.394 154.95)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text><text transform="translate(434.68 167.29)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/luftfuktighet</tspan></text><text transform="translate(434.68 200.436)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(434.68 233.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/temperatur</tspan></text><text transform="translate(434.68 266.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/luftfuktighet</tspan></text><text transform="translate(434.68 299.581)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/stue/online</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 177.692l250.212-.827"/><path fill="#fff" d="M302.665 162.982h27.792v28.448h-27.792z"/><text transform="translate(307.665 167.982)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">60</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 181.433l250.247 21.054"/><path fill="#fff" d="M331.129 182.394h37.856v28.448h-37.856z"/><text transform="translate(336.13 187.394)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(89 258)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher2</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 264.479L419.8 248.427"/><path fill="#fff" d="M246.394 244.008h41.136v28.448h-41.136z"/><text transform="translate(251.394 249.008)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 268.181l250.215 5.597"/><path fill="#fff" d="M302.665 257.245h27.792v28.448h-27.792z"/><text transform="translate(307.665 262.245)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">54</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.568 272.129l250.276 28.691"/><g><path fill="#fff" d="M331.129 278.595h37.856v28.448h-37.856z"/><text transform="translate(336.13 283.595)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text></g><g><text transform="translate(902 179)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M616.32 150.168l270.847 31.764"/></g><g><path fill="#fff" d="M700.847 148.269h41.136v28.448h-41.136z"/><text transform="translate(705.847 153.27)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">23.4</tspan></text></g><g><text transform="translate(878.61 212.134)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/+/temperatur</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M585.2 233.012l301.978-38.033"/></g><g><path fill="#fff" d="M673.484 205.078h41.136v28.448h-41.136z"/><text transform="translate(678.484 210.078)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">21.3</tspan></text></g></g></svg>

`+` kalles single-level wildcard, og brukes da som et wildcard for ett topic-nivå. Så hvis du for eksempel ønsker å regne ut gjennomsnittstemperaturen i alle rom i huset ditt kan du abonnere på `hus/+/temperatur`, og få alle meldinger som publiserer på en topic som har hus på første nivå, og temperatur på tredje nivå. 

## Hva består en mqtt-melding av 
En melding inneholder naturligvis hvilken topic den skal til, samt payloaden til meldingen (som forøvrig kan være på max 256MB). I MQTT er payload alltid binær. Publisher og Subscriber må på forhånd være enige om hvordan disse binære dataene skal tolkes. Veldig ofte er man enige om at dataene skal leses som UTF-8 encoded tekst.

### Quality of service
I tillegg setter man _Quality of Service_ (QoS). MQTT har tre nivåer av QoS, `level 0` er at most once, og `level 1` er at least once, mens `level 2` er exactly once. Default er `level 0`, som betyr at man sender av gårde meldingen og håper det går bra. Stort sett gjør det det, men det er ingen garantier. `level 1` garanterer at meldingen blir levert, men den samme meldingen _kan_ bli levert flere ganger. Bruker man `level 1` kan man altså få duplikat-meldinger (selv om det ikke er vanlig, så må man ta høyde for at det kan skje). Mens `level 2` garanterer at meldingen blir levert, og at det kun skjer en gang. Det blir litt mer nettverkets-overhead jo høyere nivå av quality of service.

### Retainflagget
Hvis temperatursensoren din sender ny melding kun når temperaturen endrer seg, så vil en ny subscriber måtte vente ganske lenge fra den begynner å subscribe på en topic til den får vite hva soveromstemperaturen er. Med mindre temperatursensoren setter retain-flagget i meldingen. Da blir den siste meldingen som er sendt til topicen lagret på MQTT-serveren, og gitt til nye subscribers når de begynner å abonnere. Hvis man bruker MQTT med retain message så blir en MQTT-server nærmest en key-value store hvor man kan abonnere på endringene man er interessert i.

## Våre tanker går til de etterlatte
Det er alltid trist når en publisher dør. Og de etterlatte subcriberne sitter ofte igjen med mange ubesvarte spørsmål. Er den virkelig død? Hva ville den skulle skje etter dens død? MQTT kan hjelpe deg med å få svar på noen av disse spørsmålene. En MQTT-klient kan skrive testament når den kobler seg opp til MQTT-serveren. Hvis klienten dør sørger serveren for å gjennomføre klients siste ønske. Hvis f.eks. temperatursensoren går tom for batteri, og dermed slutter å sende meldinger, så er det kjedelig hvis subscriberene fortsatt tror de får en ny melding når temperaturen endrer seg. Det kan _Last Will and Testament_ (LWT) forhindre. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="93 77.5 860.632 439" width="860.632" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M380 78h286v438H380z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M380 78h286v438H380z"/><text transform="translate(385 83)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(98 145)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher</tspan></text><text transform="translate(452.616 134)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(871 141.19)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M598.384 144.625l257.718 4.79"/><path fill="#fff" d="M679.66 132.263h37.856v28.448H679.66z"/><text transform="translate(684.66 137.263)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text><text transform="translate(802.694 173)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/soverom/online</tspan></text><g><text transform="translate(98 186)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="0" y="16">Last Will and Testament (LWT)</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="34.464">lastWillTopic:</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="34.464"> hus/soverom/online</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="52.912">lastWillMessage</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="52.912"> false</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="71.36">keepAlive</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="71.36"> 600</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="89.808">lastWillRetain</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="89.808"> true</tspan></text></g><g><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M169.672 153.147l268.048-7.528"/></g><g><path fill="#fff" d="M254.815 136h37.856v28.448h-37.856z"/><text transform="translate(259.815 141)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">true</tspan></text></g></g></svg>

I dette eksempelet er det en topic som heter `hus/soverom/online`. Klienten registerer seg med en last will and testament hvor klienten sier at sitt siste ønske er at det skal sendes en melding til topicen `hus/soverom/online`, med verdien `false`.

Rett etter at klienten har koblet seg til serveren publiserer den så en retained message med innholdet `true` på denne topicen. Da får alle nåværende og fremtidige klienter vite at temperatursensoren er online. 

<svg xmlns="http://www.w3.org/2000/svg" viewBox="93 77.5 860.632 439" width="860.632" height="439"><defs><marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="a" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="#000"><path d="M8 0L0-3v6z" fill="currentColor" stroke="currentColor"/></marker></defs><g fill="none"><path fill="#fff" d="M380 78h286v438H380z"/><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M380 78h286v438H380z"/><text transform="translate(385 83)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="80.512" y="16">MQTT SERVER</tspan></text><text transform="translate(98 145)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Publisher</tspan></text><text transform="translate(452.616 134)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">hus/soverom/online</tspan></text><text transform="translate(871 141.19)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">Subscriber</tspan></text><path marker-end="url(#a)" stroke="#000" stroke-linecap="round" stroke-linejoin="round" d="M598.384 144.625l257.718 4.79"/><path fill="#fff" d="M676.852 132.263h43.472v28.448h-43.472z"/><text transform="translate(681.852 137.263)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="400" x="0" y="15">false</tspan></text><g><text transform="translate(802.694 173)" fill="#000"><tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="13">hus/soverom/online</tspan></text></g><g><text transform="translate(98 186)" fill="#000"><tspan font-family="Helvetica Neue" font-size="16" font-weight="700" x="0" y="16">Last Will and Testament (LWT)</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="34.464">lastWillTopic:</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="34.464"> hus/soverom/online</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="52.912">lastWillMessage</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="52.912"> false</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="71.36">keepAlive</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="71.36"> 600</tspan> <tspan font-family="Helvetica Neue" font-size="14" font-weight="400" x="0" y="89.808">lastWillRetain</tspan> <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" y="89.808"> true</tspan></text></g></g></svg>

Men når klienten mister connection til MQTT-serveren av en eller annen grunn, så vil LWT-meldingen bli publisert av MQTT-serveren. Og alle subskribere får vite at temperatursensoren er offline. 

Serveren publiserer LWT-meldingen kun hvis klientens oppkobling blir brutt. Kobler du deg av MQTT-serveren på vanlig måte ved å sende en disconnect kommando trer ikke testamentet i kraft. Så da er du selv ansvarlig for å sende offline-meldingen før du kobler deg fra.

## Abonnement
Når du subscriber kan du velge om du vil være en _non-persistent subscriber_ eller en _persistent subscriber_. Hvis du mister connection og er en non-persistent subscriber så vil du gå glipp av alle meldingene som matcher dine abonnement mens du er frakoblet (med unntak av den siste meldingen på en topic som har retainflagget satt, da). Hvis du er en persistent subscriber tar MQTT-serveren vare på alle meldingene som matcher dine abonnement og som har QoS `level 1` eller høyere, og gir de til deg når du kobler på igjen.

Du kan også sette QoS level på subscription, og serveren kan da nedgradere QoS til et lavere nivå når den sender meldingen til subscriberen. Hvis en melding har `level 2`, og du subscriber med `level 1` så vil serveren bruke `level 2` når den mottar meldingen fra publisheren, men `level 1` når den leverer til meldingen til deg. Men du kan ikke oppgradere QoS. Hvis meldingen har `level 1` og du subscriber med `level 2` så blir meldingen levert til deg med `level 1`. 

## Hva finnes der ute?
Det finnes mange implementasjoner av både MQTT-serverer og MQTT klientbiblioteker. Den kanskje mest kjente MQTT-servereren er Apache Mosquitto. Den finnes tilgjengelig i de fleste pakkebrønner, og er den jeg bruker hjemme. Ellers tilbyr sky-leverandørene også MQTT as a service, men da gjerne med noen begrensninger.

Det finnes (minst ett) MQTT-klientbibliotek tilgjengelig i de fleste programmeringsspråk, inkludert javascript (Ja du kan sende MQTT-meldinger fra og til nettleseren med MQTT over websockets).

## Oppsummering
MQTT har noen fine egenskaper som gjør det til et godt valg hvis du har behov for å utveksle meldinger, og du ønsker å bruke så lite resurser som mulig. MQTT kan være verdt å se nærmere på neste gang du skal lage en mobilapp eller i ditt neste IoT-prosjekt. 